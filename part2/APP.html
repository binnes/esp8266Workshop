
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="IoT workshop based on ESP8266, a DHT11/22 and NeoPixel RGB LED with data analysis on the IBM Cloud." name="description"/>
<link href="https://binnes.github.io/esp8266Workshop/part2/APP.html" rel="canonical"/>
<meta content="Brian Innes" name="author"/>
<link href="../assets/images/favicon.png" rel="shortcut icon"/>
<meta content="mkdocs-1.1.2, mkdocs-material-6.1.6" name="generator"/>
<title>Creating the ESP8266 Application - ESP8266 IoT Workshop</title>
<link href="../assets/stylesheets/main.6910b76c.min.css" rel="stylesheet"/>
<link href="../assets/stylesheets/palette.196e0c26.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&amp;display=fallback" rel="stylesheet"/>
<style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
<link href="../css/extra.css" rel="stylesheet"/>
<link href="../css/pdf-print.css" rel="stylesheet"/>
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-172132667-1","binnes.github.io/esp8266Workshop"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script>
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
</head>
<body data-md-color-accent="none" data-md-color-primary="none" data-md-color-scheme="" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#creating-the-sensing-application-for-the-esp8266">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header-nav md-grid">
<a aria-label="ESP8266 IoT Workshop" class="md-header-nav__button md-logo" href="https://binnes.github.io/esp8266Workshop/" title="ESP8266 IoT Workshop">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"></path></svg>
</a>
<label class="md-header-nav__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg>
</label>
<div class="md-header-nav__title" data-md-component="header-title">
<div class="md-header-nav__ellipsis">
<span class="md-header-nav__topic md-ellipsis">
            ESP8266 IoT Workshop
          </span>
<span class="md-header-nav__topic md-ellipsis">
            
              Creating the ESP8266 Application
            
          </span>
</div>
</div>
<label class="md-header-nav__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" data-md-state="active" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</label>
<button aria-label="Clear" class="md-search__icon md-icon" data-md-component="search-reset" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header-nav__source">
<a class="md-source" href="https://github.com/binnes/esp8266Workshop/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    binnes/esp8266Workshop
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="ESP8266 IoT Workshop" class="md-nav__button md-logo" href="https://binnes.github.io/esp8266Workshop/" title="ESP8266 IoT Workshop">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"></path></svg>
</a>
    ESP8266 IoT Workshop
  </label>
<div class="md-nav__source">
<a class="md-source" href="https://github.com/binnes/esp8266Workshop/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    binnes/esp8266Workshop
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../index.html">
      Home
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" id="nav-2" type="checkbox"/>
<label class="md-nav__link" for="nav-2">
      Part 1
      <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Part 1" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-2">
<span class="md-nav__icon md-icon"></span>
        Part 1
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../part1/index.html">
      Intro
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part1/PREREQ.html">
      Setup for the Workshop
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part1/FIRSTAPP.html">
      Intro to ESP8266
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part1/WIFI.html">
      ESP8266 WiFi
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part1/LED.html">
      LED Light
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part1/DHT.html">
      Sensor
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part1/IOTCLOUD.html">
      IBM Cloud
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="nav-3" id="nav-3" type="checkbox"/>
<label class="md-nav__link" for="nav-3">
      Part 2
      <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Part 2" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-3">
<span class="md-nav__icon md-icon"></span>
        Part 2
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="index.html">
      Intro
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="DEVICE.html">
      Device setup on Cloud
    </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
        Creating the ESP8266 Application
        <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="APP.html">
      Creating the ESP8266 Application
    </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#lab-objectives">
    Lab Objectives
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#introduction">
    Introduction
  </a>
<nav aria-label="Introduction" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#step-1-create-a-new-sketch">
    Step 1 - Create a new sketch
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-2-input-the-application-code">
    Step 2 - Input the application code
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-3-run-the-code-and-view-output-using-the-serial-monitor">
    Step 3 - Run the code and view output using the Serial Monitor
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-4-understanding-how-to-work-with-json-data">
    Step 4 - Understanding how to work with JSON data
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="MQTT.html">
      Intro to MQTT
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="CERT1.html">
      IoT Security
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="CERT2.html">
      Client Certificates
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" id="nav-4" type="checkbox"/>
<label class="md-nav__link" for="nav-4">
      Part 3
      <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Part 3" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-4">
<span class="md-nav__icon md-icon"></span>
        Part 3
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../part3/index.html">
      Intro
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part3/NODERED.html">
      Node-RED
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part3/DHTDATA.html">
      Sensor Data
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part3/DASHBOARD.html">
      Dashboards
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part3/CLOUDANT.html">
      Database
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part3/HISTORY.html">
      Historical Data
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part3/INTERVAL.html">
      Reporting interval
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part3/LED.html">
      Remote LED control
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" id="nav-5" type="checkbox"/>
<label class="md-nav__link" for="nav-5">
      Part 4
      <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Part 4" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-5">
<span class="md-nav__icon md-icon"></span>
        Part 4
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../part4/index.html">
      Intro
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part4/STUDIO.html">
      Watson Studio
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part4/TRAINING.html">
      Create Training Data
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part4/JUPYTER.html">
      Jupyter Notebooks
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part4/MODEL.html">
      Run model on device
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../part4/SUMMARY.html">
      Workshop Summary
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" id="nav-6" type="checkbox"/>
<label class="md-nav__link" for="nav-6">
      Additional
      <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Additional" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-6">
<span class="md-nav__icon md-icon"></span>
        Additional
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../AGENDA.html">
      Agenda
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../RESOURCES.html">
      Resources
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../Simulator/index.html">
      Simulator
    </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#lab-objectives">
    Lab Objectives
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#introduction">
    Introduction
  </a>
<nav aria-label="Introduction" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#step-1-create-a-new-sketch">
    Step 1 - Create a new sketch
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-2-input-the-application-code">
    Step 2 - Input the application code
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-3-run-the-code-and-view-output-using-the-serial-monitor">
    Step 3 - Run the code and view output using the Serial Monitor
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-4-understanding-how-to-work-with-json-data">
    Step 4 - Understanding how to work with JSON data
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<a class="md-content__button md-icon" href="https://github.com/binnes/esp8266Workshop/edit/master/docs/part2/APP.md" title="Edit this page">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"></path></svg>
</a>
<h1 id="creating-the-sensing-application-for-the-esp8266">Creating the sensing application for the ESP8266<a class="headerlink" href="#creating-the-sensing-application-for-the-esp8266" title="Permanent link">¶</a></h1>
<h2 id="lab-objectives">Lab Objectives<a class="headerlink" href="#lab-objectives" title="Permanent link">¶</a></h2>
<p>In this lab you will pull together all the information from part 1 into a single app.  You will learn:</p>
<ul>
<li>How to create a new sketch and some recommendations for app structure</li>
<li>How to combine the WiFi, neopixel and DHT libraries into a single application</li>
<li>How to work with JSON data on the ESP8266</li>
</ul>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">¶</a></h2>
<p>In part 1 you looked at a number of example sketches to see how the WiFi, NeoPixel LED and DHT sensors work with Arduino.  Now you will create an application combining all the features then as we work through the remainder of this part you will connect the device to the IoT platform and add code to send data to the platform and receive commands from the platform.  Initially you will use unsecured MQTT connections, then at the end of this section you will add SSL/TLS and certificate verification to secure the communication.</p>
<h3 id="step-1-create-a-new-sketch">Step 1 - Create a new sketch<a class="headerlink" href="#step-1-create-a-new-sketch" title="Permanent link">¶</a></h3>
<p>Create a new sketch in the Arduino IDE using <em>File</em> -&gt; <em>New</em> or the icon in the tool bar.  The save the sketch <em>File</em> -&gt; <em>Save</em> and name the sketch, suggested name <strong>esp8266Workshop</strong>.</p>
<p>You need to add 1 more library to the Arduino IDE to provide functions to handle the JSON data format.  When we start sending and receiving data from the IoT Platform the JSON data format will be used, so we can start using JSON now.  In the Library Manager (<em>Sketch</em> -&gt; <em>Include Library</em> -&gt; <em>Manage Libraries...</em>) search for <strong>ArduinoJson</strong> and install the latest version of the library.  </p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You must have the latest version (6.x or higher) as the API changed from v5 to v6, so this code will not compile with v5 or earlier</p>
</div>
<h3 id="step-2-input-the-application-code">Step 2 - Input the application code<a class="headerlink" href="#step-2-input-the-application-code" title="Permanent link">¶</a></h3>
<p>I've provided the code for the application below.  As you enter it (or cut and paste it) please take time to ensure you understand the application and what each of the library function calls do.</p>
<p>Add the code below to the sketch above the <strong>setup()</strong> function:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;ESP8266WiFi.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Adafruit_NeoPixel.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;DHT.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;ArduinoJson.h&gt;</span><span class="cp"></span>

<span class="c1">// --------------------------------------------------------------------------------------------</span>
<span class="c1">//        UPDATE CONFIGURATION TO MATCH YOUR ENVIRONMENT</span>
<span class="c1">// --------------------------------------------------------------------------------------------</span>

<span class="c1">// Add GPIO pins used to connect devices</span>
<span class="cp">#define RGB_PIN 5 </span><span class="c1">// GPIO pin the data line of RGB LED is connected to</span>
<span class="cp">#define DHT_PIN 4 </span><span class="c1">// GPIO pin the data line of the DHT sensor is connected to</span>

<span class="c1">// Specify DHT11 (Blue) or DHT22 (White) sensor</span>
<span class="cp">#define DHTTYPE DHT11</span>
<span class="cp">#define NEOPIXEL_TYPE NEO_RGB + NEO_KHZ800</span>

<span class="c1">// Temperatures to set LED by (assume temp in C)</span>
<span class="cp">#define ALARM_COLD 0.0</span>
<span class="cp">#define ALARM_HOT 30.0</span>
<span class="cp">#define WARN_COLD 10.0</span>
<span class="cp">#define WARN_HOT 25.0</span>


<span class="c1">// Add WiFi connection information</span>
<span class="kt">char</span> <span class="n">ssid</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"XXXX"</span><span class="p">;</span>  <span class="c1">// your network SSID (name)</span>
<span class="kt">char</span> <span class="n">pass</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"YYYY"</span><span class="p">;</span>  <span class="c1">// your network password</span>


<span class="c1">// --------------------------------------------------------------------------------------------</span>
<span class="c1">//        SHOULD NOT NEED TO CHANGE ANYTHING BELOW THIS LINE</span>
<span class="c1">// --------------------------------------------------------------------------------------------</span>
<span class="n">Adafruit_NeoPixel</span> <span class="n">pixel</span> <span class="o">=</span> <span class="n">Adafruit_NeoPixel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">RGB_PIN</span><span class="p">,</span> <span class="n">NEOPIXEL_TYPE</span><span class="p">);</span>
<span class="n">DHT</span> <span class="nf">dht</span><span class="p">(</span><span class="n">DHT_PIN</span><span class="p">,</span> <span class="n">DHTTYPE</span><span class="p">);</span>

<span class="c1">// variables to hold data</span>
<span class="n">StaticJsonDocument</span><span class="o">&lt;</span><span class="mi">100</span><span class="o">&gt;</span> <span class="n">jsonDoc</span><span class="p">;</span>
<span class="n">JsonObject</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">jsonDoc</span><span class="p">.</span><span class="n">to</span><span class="o">&lt;</span><span class="n">JsonObject</span><span class="o">&gt;</span><span class="p">();</span>
<span class="n">JsonObject</span> <span class="n">status</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="n">createNestedObject</span><span class="p">(</span><span class="s">"d"</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>

<span class="kt">float</span> <span class="n">h</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="c1">// humidity</span>
<span class="kt">float</span> <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="c1">// temperature</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// LED RED value</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// LED Green value</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// LED Blue value</span>
</code></pre></div>
<p>The above code isolates all the configuration that may need to change.  I prefer to put all the config up front in an app, so it is easy to update as needed.  You will need to update the WiFI SSID and password to the WiFi network you want to connect to.  This should be available in the venue you are working in.</p>
<p>Add the following code to the <strong>setup()</strong> function:</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// Start serial console</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">setTimeout</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Serial</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"ESP8266 Sensor Application"</span><span class="p">);</span>

  <span class="c1">// Start WiFi connection</span>
  <span class="n">WiFi</span><span class="p">.</span><span class="n">mode</span><span class="p">(</span><span class="n">WIFI_STA</span><span class="p">);</span>
  <span class="n">WiFi</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span> <span class="o">!=</span> <span class="n">WL_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"."</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"WiFi Connected"</span><span class="p">);</span>

  <span class="c1">// Start connected devices</span>
  <span class="n">dht</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="n">pixel</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>This function initialises the Serial port, the WiFi connection, the LED and the DHT sensor.</p>
<p>The loop function should contain:</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">h</span> <span class="o">=</span> <span class="n">dht</span><span class="p">.</span><span class="n">readHumidity</span><span class="p">();</span>
  <span class="n">t</span> <span class="o">=</span> <span class="n">dht</span><span class="p">.</span><span class="n">readTemperature</span><span class="p">();</span> <span class="c1">// uncomment this line for Celsius</span>
  <span class="c1">// t = dht.readTemperature(true); // uncomment this line for Fahrenheit</span>

  <span class="c1">// Check if any reads failed and exit early (to try again).</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">||</span> <span class="n">isnan</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Failed to read from DHT sensor!"</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Set RGB LED Colour based on temp</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">ALARM_COLD</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">WARN_COLD</span><span class="p">)</span> <span class="o">?</span> <span class="mi">150</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">ALARM_HOT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">WARN_HOT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">150</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">ALARM_COLD</span><span class="p">)</span> <span class="o">?</span> <span class="p">((</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="n">WARN_HOT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="p">((</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">ALARM_HOT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">150</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pixel</span><span class="p">.</span><span class="n">setPixelColor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="n">pixel</span><span class="p">.</span><span class="n">show</span><span class="p">();</span>

    <span class="c1">// Print Message to console in JSON format</span>
    <span class="n">status</span><span class="p">[</span><span class="s">"temp"</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
    <span class="n">status</span><span class="p">[</span><span class="s">"humidity"</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
    <span class="n">serializeJson</span><span class="p">(</span><span class="n">jsonDoc</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>This code is called repeatedly after the <strong>setup()</strong> function returns.  It reads the humidity and temperature for the DHT sensor, validates it received the readings then sets the LED colour to the correct colour based on the temperature and the alert and warning temperatures defined in the constants at the top of the application.  Finally the temperature and humidity values are added to the JSON object, which is then converted to a string buffer and printed to the console.</p>
<h3 id="step-3-run-the-code-and-view-output-using-the-serial-monitor">Step 3 - Run the code and view output using the Serial Monitor<a class="headerlink" href="#step-3-run-the-code-and-view-output-using-the-serial-monitor" title="Permanent link">¶</a></h3>
<p>Save, compile and upload the sketch.  Once uploaded open up the Serial Monitor and set the baud rate to 115200, to match the rate set in the Serial.begin(115200) message.  You should see the confirmation that the WiFi connection has been made and then you should see the sensor data formatted as a JSON string, repeating every 10 seconds (10000 milliseconds).</p>
<p>The LED should also be set to a colour based on the temperature and the WARN and ALARM constants defined at the top of the sketch :</p>
<ul>
<li>BLUE (below ALARM_COLD)</li>
<li>TURQUOISE (between ALARM_COLD and WARM_COLD)</li>
<li>GREEN (between WARN_COLD and WARN_HOT)</li>
<li>YELLOW (between WARN_HOT and ALARM_HOT)</li>
<li>RED (above ALARM_HOT)</li>
</ul>
<h3 id="step-4-understanding-how-to-work-with-json-data">Step 4 - Understanding how to work with JSON data<a class="headerlink" href="#step-4-understanding-how-to-work-with-json-data" title="Permanent link">¶</a></h3>
<p>JSON format is widely used for APIs and data exchange between systems.  The above sketch uses one of the optimised JSON libraries for small memory devices.  To use the library you need to:</p>
<ol>
<li>Initialise the library and allocate some memory for the library to work with : <code>StaticJsonDocument&lt;100&gt; jsonDoc;</code></li>
<li>Create a new, empty JSON object : <code>JsonObject payload = jsonDoc.to&lt;JsonObject&gt;();</code></li>
<li>
<p>Add required properties using one of the available functions:</p>
<div class="highlight"><pre><span></span><code><span class="n">JsonObject</span> <span class="n">status</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="n">createNestedObject</span><span class="p">(</span><span class="s">"d"</span><span class="p">);</span>
<span class="n">status</span><span class="p">[</span><span class="s">"temp"</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
<span class="n">status</span><span class="p">[</span><span class="s">"humidity"</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
</code></pre></div>
</li>
</ol>
<p>The <strong>serializeJson()</strong> function converts the JSON object to a string and writes it into the provided buffer, so it can be used as a c-string.</p>
<p>See the library <a href="https://arduinojson.org/v6/doc/">documentation</a> for additional functionality.</p>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav aria-label="Footer" class="md-footer-nav__inner md-grid">
<a class="md-footer-nav__link md-footer-nav__link--prev" href="DEVICE.html" rel="prev">
<div class="md-footer-nav__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</div>
<div class="md-footer-nav__title">
<div class="md-ellipsis">
<span class="md-footer-nav__direction">
                  Previous
                </span>
                Device setup on Cloud
              </div>
</div>
</a>
<a class="md-footer-nav__link md-footer-nav__link--next" href="MQTT.html" rel="next">
<div class="md-footer-nav__title">
<div class="md-ellipsis">
<span class="md-footer-nav__direction">
                  Next
                </span>
                Intro to MQTT
              </div>
</div>
<div class="md-footer-nav__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"></path></svg>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
          Material for MkDocs
        </a>
 ... <a class="link--pdf-download" download href="../pdf/esp8266Workshop.pdf" title="PDF">download PDF</a></div>
</div>
</div>
</footer>
</div>
<script src="../assets/javascripts/vendor.fd16492e.min.js"></script>
<script src="../assets/javascripts/bundle.7836ba4d.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
<script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
</body>
</html>